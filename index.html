<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>TFG</title>

    <style type="text/css">
        #map {
            height: 90vh;
        }
        
        .wrap {
            display: flex;
            gap: 5px;
        }
        
        .leaflet-popup-content {
            width: 10rem;
        }
        
        .icon {
            width: 15px;
            height: 15px;
        }
        
        #input {
            font-size: 15px;
            resize: none;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
</head>

<body>
    <div id="map"></div>
    <div class="d-flex justify-content-between align-items-center m-2">
        <div class="wrap">
            <img src="./icons/mobile.ico" />
            <img src="./icons/motor.ico" />
            <img src="./icons/pagar.ico" />
            <img src="./icons/pos.ico" />
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-warning" onclick="download()">Export</button>
            <button class="btn btn-success" onclick="importData()">Import</button>
            <input type="file" id="input-button" class="d-none" />
        </div>
    </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.3/jquery.min.js" integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    // center of the map
    var center = [-6.966667, 110.416664];

    // Create the map
    var map = L.map('map').setView(center, 15);
    let imageMarker = localStorage.getItem('imageMarker') ? JSON.parse(localStorage.getItem('imageMarker')) : [];
    const random = () => {
        return (Math.random() + 1).toString(36).substring(7);
    };

    // Set up the OSM layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
    }).addTo(map);

    // add a marker in the given location
    L.marker(center).addTo(map);

    target = document.getElementById('map');
    target.ondragover = function(e) {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    };

    target.ondrop = function(e) {
        e.preventDefault();
        imagePath = e.dataTransfer.getData('text/plain');
        coordinates = map.containerPointToLatLng(L.point([e.clientX, e.clientY]));
        let id = random();
        const item = {
            coordinates,
            imagePath,
            id,
            qty: 1,
        };
        drag(item);
        imageMarker.push(item);
        localStorage.setItem('imageMarker', JSON.stringify(imageMarker));
    };

    let idIcon;
    let objectIcon = {};
    let currentQty;

    const drag = (item) => {
        let {
            coordinates,
            imagePath,
            id,
            qty
        } = item;

        var icon = L.marker(coordinates, {
                icon: L.icon({
                    iconUrl: imagePath,
                }),
                draggable: true,
            })
            .addTo(map)
            .on('click', (e) => {
                idIcon = id;
                objectIcon = icon;
            });
        icon.bindPopup(
            `<div class="d-flex flex-column gap-2">
                <div id="text">
                    <b>Note: </b><br>${qty}
                </div>
                <textarea class="form-control d-none" id="input" rows="2" placeholder="Note" ></textarea>
                <div class="d-flex justify-content-end gap-2">
                    <img class="icon" id="edit" onclick="onEdit('${qty}')" src="./icons/edit.svg" />
                    <img class="d-none icon" id="update" onclick="onUpdate()" src="./icons/check.svg" />
                    <img class="icon" id="delete" onclick="onDelete()" src="./icons/delete.svg" />
                </div>
            </div>`
        );
        icon.on('dragend', function(event) {
            idIcon = id;
            var marker = event.target;
            var position = marker.getLatLng();
            imageMarker.find((item) => item.id == idIcon).coordinates = position;
            localStorage.setItem('imageMarker', JSON.stringify(imageMarker));
        });
    };

    const onEdit = (note) => {
        $('#input').val(note);
        $('#text').toggleClass('d-none');
        $('#input').toggleClass('d-none');
        $('#update').toggleClass('d-none');
        $('#delete').toggleClass('d-none');
        $('#edit').toggleClass('d-none');
    };

    const onUpdate = () => {
        const value = $('#input').val();
        $('#text').html('');
        $('#text').toggleClass('d-none');
        $('#input').toggleClass('d-none');
        $('#update').toggleClass('d-none');
        $('#delete').toggleClass('d-none');
        $('#edit').toggleClass('d-none');
        $('#text').append('<b>Note: </b><br>' + value);
        const updateIcon = imageMarker.find((item) => item.id == idIcon);
        updateIcon.qty = value;
        localStorage.setItem('imageMarker', JSON.stringify(imageMarker));
        drag(updateIcon);
    };

    const onDelete = () => {
        map.removeLayer(objectIcon);
        const removeMarker = imageMarker.filter((item) => item.id != idIcon);
        localStorage.setItem('imageMarker', JSON.stringify(removeMarker));
    };

    imageMarker && imageMarker.map((item) => drag(item));

    // Export
    var currentdate = new Date();
    var datetime = currentdate.getDate() + '-' + (currentdate.getMonth() + 1) + '-' + currentdate.getFullYear() + '@' + currentdate.getHours() + '-' + currentdate.getMinutes() + '-' + currentdate.getSeconds();
    const download = async() => {
        const content = await localStorage.getItem('imageMarker');
        var a = document.createElement('a');
        var file = new Blob([content], {
            type: 'text/plain',
        });
        a.href = URL.createObjectURL(file);
        a.download = `tfg@${datetime}.txt`;
        a.click();
    };

    // Import
    const importData = () => {
        $('#input-button').click();
        $('#input-button').change(function(e) {
            let files = e.target.files;
            let f = files[0];
            let reader = new FileReader();
            reader.onload = (function(theFile) {
                return function(e) {
                    $('.leaflet-marker-icon').remove();
                    $('.leaflet-popup').remove();
                    imageMarker = JSON.parse(e.target.result);
                    localStorage.setItem('imageMarker', JSON.stringify(imageMarker));
                    imageMarker && imageMarker.map((item) => drag(item));
                };
            })(f);
            reader.readAsText(f);
        });
    };
</script>

</html>